name: Create DreamWeave Release

on:
  workflow_call:
    outputs:
      release_name:
        description: "Release name generated based on tag or branch."
        value: ${{ jobs.ensure-fresh-release.outputs.release_name }}

jobs:
  ensure-fresh-release:
    name: Create & Log Release
    runs-on: ubuntu-latest
    outputs:
      release_name: ${{ steps.setup.outputs.release_name }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Release Environment
        id: setup
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            RELEASE_NAME=${{ github.ref_name }}
          else
            RELEASE_NAME=development
          fi

          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT

      - name: Ensure Fresh Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_ID="${{ github.run_id }}"
          RELEASE_NAME="${{ steps.setup.outputs.release_name }}"

          RELEASE_ARGS=()
          RELEASE_ARGS+=($RELEASE_NAME)

          if [[ "$RELEASE_NAME" == "development" ]]; then
            RELEASE_ARGS+=("--prerelease")
          fi

          if RELEASE_INFO=$(gh release view $RELEASE_NAME --json body 2>/dev/null); then
            RELEASE_BODY=$(echo "$RELEASE_INFO" | jq -r '.body // ""')

            echo "Found old release from different workflow, deleting it."

            # Delete old release
            gh release delete "$RELEASE_NAME" --yes 2>/dev/null || exit 255

            # But only the tag, on development
            if [[ "$RELEASE_NAME" == "development" ]]; then
              gh api -X DELETE repos/${{ github.repository }}/git/refs/tags/"$RELEASE_NAME" 2>/dev/null
            fi

            # Create new release with our workflow ID
            echo "Creating new release for this workflow..."

            if gh release create "${RELEASE_ARGS[@]}" --generate-notes; then

              # Append our workflow marker to the generated notes
              gh release edit "$RELEASE_NAME" --notes-file <(gh release view "$RELEASE_NAME" --json body --jq '.body' && echo -e "\n\n---\nGenerated by workflow run: $WORKFLOW_ID")
              echo "✓ Created and tagged new release"

            else
              echo "Release creation failed!" && exit 255
            fi
          else
            echo "No release found at all, making a new one . . ."

            if gh release create "${RELEASE_ARGS[@]}" --generate-notes; then
              # Append our workflow marker
              gh release edit "$RELEASE_NAME" --notes-file <(gh release view "$RELEASE_NAME" --json body --jq '.body' && echo -e "\n\n---\nGenerated by workflow run: $WORKFLOW_ID")
              echo "✓ Created new release"
            else
              echo "Release creation failed!" && exit 255
            fi
          fi
