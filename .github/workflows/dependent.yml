name: Notify DreamWeave Ecosystem

on:
  workflow_call:
    secrets:
      DW_BOT_PAT:
        required: true

    inputs:
      aur_package_name:
        type: string
        required: true
      target_repo:
        type: string
        required: true

jobs:
  notify-dependents:
    name: Notify Dependent Repositories
    runs-on: ubuntu-latest

    steps:
      - name: Create Update Issue
        env:
          GH_TOKEN: ${{ secrets.DW_BOT_PAT }}
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          VERSION="${{ github.ref_name }}"

          ISSUE_TITLE="ðŸ“¦ Update $REPO_NAME dependency to $VERSION"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/$VERSION"

          ISSUE_BODY=$(cat <<EOF
          ## ðŸš¨ Dependency Update Required: [${{ github.repository }}](https://github.com/${{ github.repository }})

          **New Version:** [${{ github.ref_name }}]($RELEASE_URL)
          **Released By:** @${{ github.actor }} **on** $(date -u +"%Y-%m-%d %H:%M UTC")
          [$REPO_NAME on the AUR](https://aur.archlinux.org/packages/${{ inputs.aur_package_name }})

          ### ðŸ“‹ Required Actions
          Please test integration with $REPO_NAME version $VERSION.
          Close this issue via linked pull request when the integration is confirmed working.

          *This issue was automatically created by GitHub Actions.*
          EOF
          )

          echo "Creating issue in ${{ inputs.target_repo }}..."

          gh issue create \
            --repo "${{ inputs.target_repo }}" \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --label "dependencies,automated" \
            --assignee "${{ github.actor }}"
